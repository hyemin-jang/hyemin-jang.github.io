---
title: '[Java] 12. JPA'
date: 2021-08-21 13:08:79
category: 'Java'
thumbnail: { thumbnailSrc }
draft: false
---

# 1. JPA

: **Java Persistence API**

ìë°” ì§„ì˜ì˜ `ORM` ê¸°ìˆ  í‘œì¤€. ìë°” ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì„ ì •ì˜í•œ `ì¸í„°í˜ì´ìŠ¤`ì´ë‹¤.

> ğŸ’¡ **ORM**(Object Relational Mapping)
>
> - SQLì„ ì§ì ‘ ë‹¤ë£¨ì§€ ì•Šê³ , **ê°ì²´ì™€ í…Œì´ë¸”ì„ ë§¤í•‘**í•˜ì—¬ ê°„ì ‘ì ìœ¼ë¡œ DBë°ì´í„° ê´€ë¦¬
>
> - ê°ì²´ ê°„ ê´€ê³„ë¥¼ ë°”íƒ•ìœ¼ë¡œ SQL ë¬¸ì¥ ìë™ ìƒì„±
> - SQLì´ ì•„ë‹Œ ë©”ì†Œë“œë¡œ ë°ì´í„° ì¡°ì‘



### ğŸŒˆ ìë°” DBì—°ë™ ê¸°ìˆ ì˜ ë³€ì²œì‚¬

1. EJBì˜ Entityë¹ˆ : êµ¬í˜„ ë° ë°°í¬ ì–´ë ¤ì›€ ë“±ì˜ ì—¬ëŸ¬ê°€ì§€ ì´ìŠˆ ìˆì—ˆìŒ
2. Hibernate : ìë°” í‘œì¤€ì€ ì•„ë‹ˆì§€ë§Œ ê°€ì¥ ë§ì€ ê°œë°œìë“¤ì´ ì‚¬ìš©í•˜ëŠ” ORM ê¸°ìˆ 
3. JPA : í•˜ì´ë²„ë„¤ì´íŠ¸ ê°œë°œìë“¤ì´ ë§Œë“  ìë°” í‘œì¤€ ORM ê¸°ìˆ 



## 1) JPA ì‹¤í–‰ êµ¬ì¡°

ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ JDBC ì‚¬ì´ì—ì„œ ë™ì‘.

ê°œë°œìê°€ JPAë¥¼ ì‚¬ìš©í•˜ë©´ JPA ë‚´ë¶€ì—ì„œ JDBC APIë¥¼ ì‚¬ìš©í•˜ì—¬ SQLì„ í˜¸ì¶œ, DBì™€ í†µì‹ í•œë‹¤.

![image-20210821122034216](C:\Users\hmjan\AppData\Roaming\Typora\typora-user-images\image-20210821122034216.png)





## 2) JPAë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ 

### (1) ìƒì‚°ì„± ì¦ê°€ ë° ìœ ì§€ë³´ìˆ˜ì˜ ìš©ì´

- ê°„ë‹¨í•œ ë©”ì†Œë“œë¡œ CRUDê°€ ê°€ëŠ¥í•˜ë‹¤.

- í•„ë“œ ë³€ê²½ì‹œ ì§ì ‘ ëª¨ë“  SQLì„ ìˆ˜ì •í•´ì•¼ í•  í•„ìš” ì—†ì´ JPAê°€ ì•Œì•„ì„œ ì²˜ë¦¬í•´ì¤€ë‹¤.

### (2) ë°ì´í„° ì ‘ê·¼ ì¶”ìƒí™”, ë²¤ë” ë…ë¦½ì  ê°œë°œ

![image-20210821122241424](C:\Users\hmjan\AppData\Roaming\Typora\typora-user-images\image-20210821122241424.png)

- Objectì™€ RDBê°„ì˜ íŒ¨ëŸ¬ë‹¤ì„ ë¶ˆì¼ì¹˜ í•´ê²°





## 3) JPAì˜ ì„±ëŠ¥ ìµœì í™” ê¸°ëŠ¥

### (1) 1ì°¨ ìºì‹œì™€ ë™ì¼ì„±(identity) ë³´ì¥

- ê°™ì€ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œëŠ” ê°™ì€ Entityë¥¼ ë°˜í™˜ - ì¡°íšŒ ì„±ëŠ¥ (ì•½ê°„) í–¥ìƒ

> ğŸ’¡ **ìºì‹œ (Cache)**
>
> - ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ë³µì‚¬í•´ ë†“ëŠ” ì„ì‹œ ì €ì¥ì†Œ
> - ê¸°ì¡´ ë°ì´í„°ì— ì ‘ê·¼í•˜ëŠ” ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ê²½ìš° / ê°’ì„ ë‹¤ì‹œ ê³„ì‚°í•˜ëŠ” ì‹œê°„ì„ ì ˆì•½í•˜ê³  ì‹¶ì€ ê²½ìš° ì‚¬ìš©
> - ìºì‹œì— ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ë³µì‚¬í•´ ë†“ìœ¼ë©´ ì ‘ê·¼ í˜¹ì€ ê³„ì‚° ì—†ì´ ë” ë¹ ë¥¸ ì†ë„ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ

```java
selectë¬¸ì¥ ì‹¤í–‰ ì•ˆí•˜ëŠ”ê²½ìš°
```



### (2) íŠ¸ëœì­ì…˜ì„ ì§€ì›í•˜ëŠ” ì“°ê¸° ì§€ì› (transactional write-behind)

- Update, Deleteë¡œ ì¸í•œ ë¡œìš°(Row) ë½ ì‹œê°„ ìµœì†Œí™”
- ì§€ì—° ë¡œë”© ???????? ë­”ì†Œë¦¬ì•¼





-------------------------

# 2. JPA Application ê°œë°œ

## 1) ê°œë°œ í™˜ê²½ êµ¬ì¶•

1. JPA í”„ë¡œì íŠ¸ë¡œ ë³€í™˜
2. Maven í”„ë¡œì íŠ¸ë¡œ ë³€í™˜ - 

### ğŸ’ JPA ì„¤ì •íŒŒì¼ (persistence.xml) ì´í•´í•˜ê¸°

```xml
<?xml version="1.0" encoding="UTF-8"?>
<persistence version="2.1" 
             xmlns="http://xmlns.jcp.org/xml/ns/persistence" 
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd">
	
    <persistence-unit name="oracleDB">	
        <class>model.entity.Customer</class>

        <properties>
            <property name="javax.persistence.jdbc.driver" 
                      value="oracle.jdbc.OracleDriver" />
            <property name="javax.persistence.jdbc.url" 
                      value="jdbc:oracle:thin:@127.0.0.1:1521:xe" />
            <property name="javax.persistence.jdbc.user" 
                      value="SCOTT" />
            <property name="javax.persistence.jdbc.password" 
                      value="TIGER" />

            <!-- ë°©ì–¸ì²˜ë¦¬ê¸° -->
            <property name="hibernate.dialect" 
                      value="org.hibernate.dialect.OracleDialect" />

            <property name="hibernate.hbm2ddl.auto" value="create" />
        </properties>
	</persistence-unit>	
</persistence>
```

- `<persistence-unit>` : JPAê°€ ì—°ë™í•  DataBaseì— ëŒ€í•œ ì •ë³´ ë³´ìœ  (ì—°ë™í•˜ê³ ì í•˜ëŠ” DBê°€ ì—¬ëŸ¬ê°œì¸ ê²½ìš° ì—¬ëŸ¬ê°œì˜ persistence-unit ì„¤ì •í•˜ë©´ ë¨)
  - JDBC Driver ì¢…ë¥˜ / url / user /password ì •ë³´ ê°€ì§€ê³  ìˆìŒ
- `<class>model.entity.Customer</class>` : Entity í´ë˜ìŠ¤ë¥¼ ë“±ë¡
- ê° ì†ì„±(property)ì˜ ì˜ë¯¸
  - `<property name="hibernate.show_sql" value="true" />` : ì½˜ì†”ì°½ì— ìƒì„±ëœ sqlë¬¸ ì¶œë ¥í•˜ê² ë‹¤
  - `<property name="hibernate.id.new_generator_mappings" value="true" />` : 
  - `<property name="hibernate.hbm2ddl.auto" value="create" />` : DDL(í…Œì´ë¸” ìƒì„±, ì‚­ì œ, ë³€ê²½)ì„ ìë™ìœ¼ë¡œ ì‹¤í–‰í•˜ê² ë‹¤. (ì‹¤í–‰í•˜ì§€ ì•Šìœ¼ë ¤ëŠ” ê²½ìš° value="none")



## 2) ì—°ê´€ê´€ê³„ ë§¤í•‘

: ê°ì²´ì˜ ì°¸ì¡° ê´€ê³„ì™€ í…Œì´ë¸”ì˜ ì™¸ë˜í‚¤ë¥¼ ë§¤í•‘í•˜ëŠ” ê²ƒì„ ì˜ë¯¸

â€‹	âš¡ Member ê°ì²´ê°€ Team ê°ì²´ë¥¼ ì°¸ì¡°í•˜ëŠ” ê²½ìš°

![image-20210821133801987](C:\Users\hmjan\AppData\Roaming\Typora\typora-user-images\image-20210821133801987.png)

- JDBC : ì—°ê´€ ê´€ê³„ì´ ìˆëŠ” ìƒëŒ€ í…Œì´ë¸”ì˜ PKë¥¼ ë©¤ë²„ë³€ìˆ˜ë¡œ ê°€ì§„ë‹¤
- JPA : **ì—”í‹°í‹° ê°ì²´ ìì²´ë¥¼ í†µì±„ë¡œ ì°¸ì¡°í•œë‹¤**

```java
// JDBCì—ì„œì˜ ì„¤ê³„
class Member{
    private long memberId;
    private String name;
    private long teamId;
}

// JPAì—ì„œì˜ ì„¤ê³„
class Member{
    private long memberId;
    private String name;
    private Team team;  // ì—”í‹°í‹° ê°ì²´ë¥¼ ì°¸ì¡°
}
```





### (1)  **ë‹¤ì¤‘ì„±** - í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ìƒëŒ€ ì—”í‹°í‹°ë¥¼ ë°”ë¼ë´¤ì„ë•Œ

- OneToOne : ì¼ëŒ€ì¼ ê´€ê³„
- OneToMany : ì¼ëŒ€ë‹¤ ê´€ê³„
- ManyToOne : ë‹¤ëŒ€ì¼ ê´€ê³„
- ManyToMany : ë‹¤ëŒ€ë‹¤ ê´€ê³„

DB ì„¤ê³„ìƒ **'ë‹¤'ì¸ ìª½ì´ ì™¸ë˜ í‚¤ë¥¼ ê°–ëŠ”ë‹¤**. ğŸ˜Šë¬´.ì¡°.ê±´.



### (2) ë°©í–¥

ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì€ ì™¸ë˜í‚¤ í•˜ë‚˜ë¡œ ì–‘ìª½ í…Œì´ë¸”ì„ ì¡°ì¸í•˜ë¯€ë¡œ ë‹¨ë°©í–¥ì´ë‹ˆ ì–‘ë°©í–¥ì´ë‹ˆ ë‚˜ëˆŒ í•„ìš”ê°€ ì—†ë‹¤.

í•˜ì§€ë§Œ ê°ì²´ëŠ” ì°¸ì¡°ìš© í•„ë“œê°€ ìˆëŠ” ê°ì²´ë§Œ ë‹¤ë¥¸ ê°ì²´ë¥¼ ì°¸ì¡°í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë¯€ë¡œ, JPAë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì™€ íŒ¨ëŸ¬ë‹¤ì„ì„ ë§ì¶”ê¸° ìœ„í•´ì„œëŠ” ì—°ê´€ê´€ê³„ì˜ ë°©í–¥ì„ ì„ íƒí•´ì•¼ í•œë‹¤.

- **ë‹¨ë°©í–¥ ê´€ê³„** : í•œìª½ì˜ ì—”í‹°í‹°ë§Œ ì°¸ì¡°ìš© í•„ë“œë¥¼ ê°–ê³  ë‹¤ë¥¸ ê°ì²´ë¥¼ ì°¸ì¡°í•˜ê³  ìˆëŠ” ê²ƒ
- **ì–‘ë°©í–¥ ê´€ê³„** : ì–‘ìª½ ì—”í‹°í‹°ê°€ ê°ê° ì°¸ì¡°ìš© í•„ë“œë¥¼ ê°–ê³  ì„œë¡œ ì°¸ì¡°í•˜ê³  ìˆëŠ” ê²ƒ

> ğŸ¤·â€â™€ï¸ ì–´ë–»ê²Œ íŒë‹¨í•˜ë‚˜ìš”?
>
> - ë‹¤ëŒ€ì¼ ë‹¨ë°©í–¥ ê´€ê³„ : member1.getTeam() ì²˜ëŸ¼ ë©¤ë²„ê°€ íŒ€ì„ ì°¸ì¡° ê°€ëŠ¥
> - ì–‘ë°©í–¥ ê´€ê³„ : team1.getMember()ì²˜ëŸ¼ íŒ€ì´ ë©¤ë²„ë¥¼ ì°¸ì¡°ë„ ê°€ëŠ¥í•˜ê²Œ í•˜ë ¤ë©´ ì–‘ë°©í–¥ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ë¨
>
> => ì—­ë°©í–¥ìœ¼ë¡œ ê°ì²´ íƒìƒ‰ì´ ê¼­ í•„ìš”í• ë•Œ ì–‘ë°©í–¥ ê´€ê³„ë¥¼ ì„¤ì •í•˜ì



### (3) ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸(Owner)

- ë‘ ê°ì²´ê°€ ì–‘ë°©í–¥ ê´€ê³„ë¥¼ ê°€ì§ˆ ë•Œ, ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ì„ ì§€ì •í•´ì•¼ í•œë‹¤.

- **ì™¸ë˜í‚¤ë¥¼ ê°–ëŠ” í…Œì´ë¸”**ì´ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ì´ ëœë‹¤. ğŸ˜Šë¬´.ì¡°.ê±´.
  - ì£¼ì¸ ìª½ì´ ì™¸ë˜í‚¤ë¥¼ ê´€ë¦¬(ë“±ë¡, ìˆ˜ì •, ì‚­ì œ)í•  ìˆ˜ ìˆê³ , ë‹¤ë¥¸ ìª½ì€ ì½ê¸°ë§Œ ê°€ëŠ¥í•˜ë‹¤.
- ì£¼ì¸ì´ ì•„ë‹Œ ê°ì²´ ìª½ì—ì„œ `mappedBy` ì†ì„±ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```java
@Entity
class Team{	
	@Id	
	@Column(name="team_id")
	private Long teamId;

	@Column(length=20, name="team_name")
	private String teamName;
	
    /* í•´ë‹¹ ì—”í‹°í‹°(Team)ê°€ ìƒëŒ€ ì—”í‹°í‹°(Member)ì˜ ì—¬ëŸ¬ ê°ì²´ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŒ 
     * `ì¼`ì¸ ìª½ì— @OneToManyë¥¼ ì¶”ê°€í•˜ì—¬ ì–‘ë°©í–¥ ê´€ê³„ ë§Œë“¬ 
     * 	- íŒ€ì—ì„œ ì—¬ëŸ¬ ë©¤ë²„ë“¤ì„ ì°¸ì¡° ê°€ëŠ¥í•˜ê²Œ ArrayList ë§Œë“¤ì–´ì¤€ë‹¤
     * mappedBy ì‚¬ìš©í•˜ì—¬ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ì„ ì„¤ì •í•´ì¤Œ 
     * 	- mappedByì˜ ê°’ì€ ëŒ€ìƒì´ ë˜ëŠ” ë³€ìˆ˜ëª…(Member í…Œì´ë¸”ì˜ teamId ë³€ìˆ˜)
     */
	@OneToMany(mappedBy="teamId")       
	List<Member> members = new ArrayList<Member>();
	
	

@Entity
class Member{
    @Id
    @Column(name="member_id")
    private long memberId;
    
    @Column(length=20)
    private String name;
    
    // JoinColumn : ì™¸ë˜í‚¤ë¥¼ ë§¤í•‘í•˜ëŠ” ì• ë…¸í…Œì´ì…˜. 
    // í•´ë‹¹ ì—”í‹°í‹°(Member)ì˜ ì—¬ëŸ¬ ê°ì²´ê°€ ìƒëŒ€ ì—”í‹°í‹°(Team)ì— ëŒ€ì‘ - ë‹¤ëŒ€ì¼ ê´€ê³„(@ManyToOne)
    @JoinColumn(name="team_id")  
    @ManyToOne
    private Team team;
}
```



## 3) ê°œë°œ Proccess

- EntityManagerFactory ìƒì„± 
- EntityManager ìƒì„± 
- EntityTransaction ìƒì„± ë° ì ìš© 
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(CRUD) 
- ìì›ë°˜í™˜

| API                  | ì—­í•                                                          |
| -------------------- | ------------------------------------------------------------ |
| Persistence          | EntityManagerFactory ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì–»ê¸° ìœ„í•œ ë©”ì†Œë“œë¥¼ ê°€ì§ = `createEntityManagerFactory()` |
| EntityManagerFactory | ì—¬ëŸ¬ EntityManager ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‘ì„±í•˜ê³  ê´€ë¦¬                  |
| EntityManager        | ê°ì²´ì˜ ì§€ì†ì„± ì‘ì—…ì„ ê´€ë¦¬. CRUD ìˆ˜í–‰.                        |
| EntityTransaction    | EntityManagerì™€ 1:1 ê´€ê³„. ê° EntityManagerì˜ ì‘ì—…ì€ EntityTransaction í´ë˜ìŠ¤ì— ì˜í•´ ìœ ì§€ ê´€ë¦¬. |

| ë©”ì†Œë“œ                                      | ê¸°ëŠ¥                                           |
| ------------------------------------------- | ---------------------------------------------- |
| persist(Object entity)                      | entityë¥¼ ì˜ì†í™” (INSERT)                       |
| merge(Object entity)                        | ì¤€ì˜ì† ìƒíƒœì˜ entityë¥¼ ì˜ì†í™” (UPDATE)         |
| remove(Object entity)                       | ì˜ì† ìƒíƒœì˜ entityë¥¼ ì œê±° (DELETE)             |
| find(Class entity, Object pk)               | í•˜ë‚˜ì˜ entity ê²€ìƒ‰ (SELECT one)                |
| createQuery(String jpql, Class resultClass) | JPQLì— í•´ë‹¹í•˜ëŠ” entity ëª©ë¡ ê²€ìƒ‰ (SELECT list) |



```java
public class RunningTest {
	
	void test() {
		EntityManagerFactory emf = Persistence.createEntityManagerFactory("oracleDB");
		EntityManager em = emf.createEntityManager();
		EntityTransaction tx = em.getTransaction();
		
        tx.begin();
		
        try{
        // ì—”í‹°í‹° í´ë˜ìŠ¤ì˜ setter ë©”ì†Œë“œ - tx.commit() ì‹œì— UPDATEë¬¸ ìˆ˜í–‰ 
            Team t1 = new Team();
            t1.setTeamName("ìš°ë¦¬íŒ€");

            Member m1 = new Member();
            m1.setName("ì¥ë³´ë¦¬");
            m1.setTeamId(t1);

            Member m2 = new Member();
            m2.setName("ì„œë¦¬íƒœ");
            m2.setTeamId(t1);

            t1.getMembers().add(m1);
            t1.getMembers().add(m2);
            t1.getMembers().add(m3);

            // INSERT
            em.persist(t1);
            em.persist(m1);		
            em.persist(m2);
           
            // SELECT one
            Member oneMember = em.find(Member.class, 1L);  // pkê°’(1L)ìœ¼ë¡œ ì¡°íšŒ
            System.out.println("ì¡°íšŒí•œ ë©¤ë²„ : " + oneMember);
            
            // SELECT list
            List<Member> allMember = em.createQuery(
                "select m from Member m", Member.class).getResultList();
			System.out.println("ë©¤ë²„ ìˆ˜ : " + allMember.size());

		    // DELETE
            em.remove(m);  // ê°ì²´ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì„œ pkê°’ì„ í†µí•´ í•´ë‹¹ ë°ì´í„° ì‚­ì œ

            tx.commit();
            
        }catch(Exception e) {
            // ì—ëŸ¬ ë°œìƒì‹œ CRUD ê²°ê³¼ ì €ì¥í•˜ì§€ ì•Šê³  rollback
			tx.rollback();  
			e.printStackTrace();
		}finally {
            // ìì›ë°˜í™˜
			em.close();
			emf.close();
		}
	}

}
```





[ì°¸ê³ í•œ ì‚¬ì´íŠ¸]

https://jeong-pro.tistory.com/231