{"componentChunkName":"component---src-templates-blog-post-js","path":"/Next.js/next-redux-wrapper/","result":{"data":{"site":{"siteMetadata":{"title":"Hyem.log","author":"[hyem]","siteUrl":"https://hyemin-jang.github.io","comment":{"disqusShortName":"","utterances":"hyemin-jang/hyemin-jang.github.io"},"sponsor":{"buyMeACoffeeId":"jbee"}}},"markdownRemark":{"id":"58090e1c-d89f-56aa-93fb-4faef898a96d","excerpt":"Next.js의 Pre-rendering Next.js는 React로 SSR(Server Side Rendering)을 가능하게 해주는 프레임워크이다. 페이지는 서버가 로드해주고, 페이지가 그려진 이후 페이지 내부에서 동적인 데이터를 fetch하는 과정은 CSR(Client Side Rendering) 방식을 따른다. 그렇기 때문에 페이지가 로드될 때 데이터가 함께 fetch 되어야 하는 상황이라면 Next.js…","html":"<h2 id=\"nextjs의-pre-rendering\" style=\"position:relative;\"><a href=\"#nextjs%EC%9D%98-pre-rendering\" aria-label=\"nextjs의 pre rendering permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Next.js의 Pre-rendering</h2>\n<p>Next.js는 React로 SSR(Server Side Rendering)을 가능하게 해주는 프레임워크이다.</p>\n<p>페이지는 서버가 로드해주고, 페이지가 그려진 이후 페이지 내부에서 동적인 데이터를 fetch하는 과정은 CSR(Client Side Rendering) 방식을 따른다.</p>\n<p>그렇기 때문에 <strong>페이지가 로드될 때 데이터가 함께 fetch 되어야 하는 상황</strong>이라면 Next.js가 제공하는 <code class=\"language-text\">getInitialProps</code>, <code class=\"language-text\">getStaticProps</code>, <code class=\"language-text\">getStaticPath</code>, <code class=\"language-text\">getServerSideProps</code> 를 이용해 첫 렌더링 때 데이터가 페칭될 수 있도록 처리해 주어야 한다.</p>\n<h2 id=\"next에서-redux를-사용하려면\" style=\"position:relative;\"><a href=\"#next%EC%97%90%EC%84%9C-redux%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%A0%A4%EB%A9%B4\" aria-label=\"next에서 redux를 사용하려면 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Next에서 Redux를 사용하려면?</h2>\n<ul>\n<li>Next.js의 Pre-rendering을 가능하게 해주는 <code class=\"language-text\">getInitialProps</code>, <code class=\"language-text\">getServerSideProps</code> 등에서 store에 접근하기 위해</li>\n<li>\n<p>서버 측의 store와 클라이언트 측의 store를 합쳐 주기 위해</p>\n<p><strong>next-redux-wrapper</strong> 라는 라이브러리가 필요하다.</p>\n</li>\n</ul>\n<br>\n<p>✅ store/index.js</p>\n<ul>\n<li><code class=\"language-text\">HYDRATE</code> action handler를 가지고 있는 리듀서 생성 - 서버측 store의 상태를 클라이언트 측 store에 합쳐주는 역할</li>\n<li>makeStore 함수 생성</li>\n<li>makeStore 함수를 인자로 받는 createWrapper 함수 export</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">HYDRATE</span><span class=\"token punctuation\">,</span> createWrapper<span class=\"token punctuation\">,</span> MakeStore <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next-redux-wrapper'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> configureStore<span class=\"token punctuation\">,</span> combineReducers <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@reduxjs/toolkit'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> common <span class=\"token keyword\">from</span> <span class=\"token string\">'./common'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> searchSite <span class=\"token keyword\">from</span> <span class=\"token string\">'./searchRoom'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> user <span class=\"token keyword\">from</span> <span class=\"token string\">'./user'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> registerRoom <span class=\"token keyword\">from</span> <span class=\"token string\">'./registerRoom'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> auth <span class=\"token keyword\">from</span> <span class=\"token string\">'./auth'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> room <span class=\"token keyword\">from</span> <span class=\"token string\">'./room'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> reservation <span class=\"token keyword\">from</span> <span class=\"token string\">'./reservation'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//* redux-toolkit 의 combineReducers() 사용하여 여러 모듈화된 리듀서 합친 rootReducer 생성</span>\n<span class=\"token keyword\">const</span> rootReducer <span class=\"token operator\">=</span> <span class=\"token function\">combineReducers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n\tcommon<span class=\"token operator\">:</span> common<span class=\"token punctuation\">.</span>reducer<span class=\"token punctuation\">,</span>\n\tuser<span class=\"token operator\">:</span> user<span class=\"token punctuation\">.</span>reducer<span class=\"token punctuation\">,</span>\n\tauth<span class=\"token operator\">:</span> auth<span class=\"token punctuation\">.</span>reducer<span class=\"token punctuation\">,</span>\n\tregisterRoom<span class=\"token operator\">:</span> registerRoom<span class=\"token punctuation\">.</span>reducer<span class=\"token punctuation\">,</span>\n\tsearchRoom<span class=\"token operator\">:</span> searchSite<span class=\"token punctuation\">.</span>reducer<span class=\"token punctuation\">,</span>\n\troom<span class=\"token operator\">:</span> room<span class=\"token punctuation\">.</span>reducer<span class=\"token punctuation\">,</span>\n\treservation<span class=\"token operator\">:</span> reservation<span class=\"token punctuation\">.</span>reducer<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> type RootState <span class=\"token operator\">=</span> ReturnType<span class=\"token operator\">&lt;</span><span class=\"token keyword\">typeof</span> rootReducer<span class=\"token operator\">></span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 스토어의 타입 얻기</span>\n<span class=\"token keyword\">let</span> initialRootState<span class=\"token operator\">:</span> RootState<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//* rootReducer에 타입이 __NEXT_REDUX_WRAPPER_HYDRATE__ 인 액션 추가 </span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reducer</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token operator\">:</span> any<span class=\"token punctuation\">,</span> action<span class=\"token operator\">:</span> any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token constant\">HYDRATE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>     \n        <span class=\"token comment\">// 빈 초기상태라면 payload(=서버 측 store의 state)로 덮어씌워준다               </span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state <span class=\"token operator\">===</span> initialRootState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token operator\">...</span>action<span class=\"token punctuation\">.</span>payload<span class=\"token punctuation\">,</span>  \n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">return</span> state<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token function\">rootReducer</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//* 리덕스 store를 리턴하는 makeStore 함수 생성</span>\n<span class=\"token keyword\">const</span> makeStore<span class=\"token operator\">:</span> MakeStore<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token function\">configureStore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n\t\treducer<span class=\"token punctuation\">,</span>\n\t\tdevTools<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tinitialRootState <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">return</span> store<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//* 리덕스 스토어를 wrapper로 만들어서 export하기</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> wrapper <span class=\"token operator\">=</span> <span class=\"token function\">createWrapper</span><span class=\"token punctuation\">(</span>makeStore<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> debug<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Next.js로 SSR을 하게 되면 사용자가 요청할 때마다 redux store를 새로 만들게 된다.</p>\n<p>makeStore로 하나의 store를 다루도록 설정하여 클라이언트 단에서 redux store가 여러개 생성되는 것을 방지한다.</p>\n<br>\n<p>✅ pages/_app.tsx</p>\n<ul>\n<li>wrapper로 HOC 패턴으로 사용하여 App을 인자로 전달 => HYDRATE action type을 받을 수 있도록 한다 </li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// Next 6버전 이후로 &lt;Provider>로 감싸지 않아도 되도록 바뀜. </span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">app</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> Component<span class=\"token punctuation\">,</span> pageProps <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> AppProps</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\t\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">GlobalStyle</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n\t\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Header</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n\t\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Component</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">...</span><span class=\"token attr-value\">pageProps</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n\t\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>root-modal<span class=\"token punctuation\">'</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">withRedux</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<p>페이지가 <code class=\"language-text\">getStaticProps</code> 또는 <code class=\"language-text\">getServerSideProps</code>를 가지고 있으면 사용자가 해당 페이지를 요청할 때마다 <strong>HYDRATE action</strong>이 발생한다. </p>\n<blockquote>\n<h3 id=\"-hydrate\" style=\"position:relative;\"><a href=\"#-hydrate\" aria-label=\" hydrate permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>💡 Hydrate?</h3>\n<p>넥스트가 서버 단에서 미리 pre-rendering한 HTML document를 클라이언트에게 전송한다. 그런데 이 때 클라이언트가 받은 웹페이지는 자바스크립트 요소들이 하나도 없는, 클릭 등의 이벤트 리스너들조차도 하나도 적용돼 있지 않은 상태이다. </p>\n<p>넥스트 서버가 pre-rendering 된 페이지를 보내고 나서, 바로 리액트가 번들링된 JS 코드를 클라이언트에게 전송한다. 그러면 이 JS 코드들이 이전에 보내진 HTML DOM 요소 위에서 한 번 더 렌더링을 하면서 자기 자리를 찾아가 매칭이 되는데, 이를 DOM 요소 위에 물을 채우듯 필요로 하던 요소들을 채운다 하여 <strong>Hydrate</strong>라고 부른다.</p>\n</blockquote>\n<p>이 액션의 payload는 서버에서 static generation 또는 server side rendering이 발생할 때 생성한 state를 담고 있다. 그래서 <strong>서버에서 생성한 state를 클라이언트 쪽에서도 사용할 수 있게 합쳐주는 (state reconciliation)</strong> 역할을 한다.</p>\n<p>참고로 페이지 레벨에서 <code class=\"language-text\">getServerSideProps</code> 또는 <code class=\"language-text\">getStaticProps</code>를 사용하면 App.getInitialProps도 무조건 발생해 HYDRATE action 이 두번 dispatch된다. </p>\n<p>(App.getInitialProps 직후의 state로 한번, getServerSideProps / getStaticProps 직후의 state로 한번)</p>\n<br>\n<h2 id=\"issue1-로그인-상태-유지하기\" style=\"position:relative;\"><a href=\"#issue1-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%83%81%ED%83%9C-%EC%9C%A0%EC%A7%80%ED%95%98%EA%B8%B0\" aria-label=\"issue1 로그인 상태 유지하기 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Issue1. 로그인 상태 유지하기</h2>\n<p>클라이언트 측 store는 각 페이지를 요청할 때마다 초기화되므로, 모든 페이지에서 로그인한 유저 정보를 유지할 수 있도록 <strong>_app.tsx</strong>에서 <code class=\"language-text\">getInitialAppProps</code>를 사용하였다.</p>\n<p>쿠키에 access_token이 있다면 로그인한 유저 정보를 불러오는 api를 호출하고, 받은 데이터를 store에 저장하는 로직을 추가하여 모든 페이지 요청시마다 실행될 수 있도록 하였다. </p>\n<p>⚡ next-redux-wrapper 가 7버전으로 업데이트되면서  <code class=\"language-text\">getInitialProps</code>를 해당 상황에 적절한 wrapper로 감싸줘야 한다 :  <code class=\"language-text\">wrapper.getInitialAppProps</code> 또는 <code class=\"language-text\">wrapper.getInitialPageProps</code>를 사용한다.</p>\n<p>⚡ 또한 <code class=\"language-text\">({store, req, res, ...}) =&gt; { ... }</code> 에서 <code class=\"language-text\">store =&gt; ({req, res, ...}) =&gt; { ... }</code> 와 같이 함수 사용법이 바뀌었다.</p>\n<p>처음에 이거 몰라서 고생 많이함…</p>\n<p>✅ pages/_app.tsx</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> App<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> AppProps <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next/app'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'../lib/api'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Header <span class=\"token keyword\">from</span> <span class=\"token string\">'../components/Header'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> GlobalStyle <span class=\"token keyword\">from</span> <span class=\"token string\">'../styles/GlobalStyle'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> wrapper <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../store'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> cookieStringToObject <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../lib/utils'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> meAPI <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../lib/api/auth'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> userActions <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../store/user'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">app</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> Component<span class=\"token punctuation\">,</span> pageProps <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> AppProps</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\n\t\t\t<span class=\"token operator\">&lt;</span>GlobalStyle <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n\t\t\t<span class=\"token operator\">&lt;</span>Header <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n\t\t\t<span class=\"token operator\">&lt;</span>Component <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>pageProps<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n\t\t\t<span class=\"token operator\">&lt;</span>div id<span class=\"token operator\">=</span><span class=\"token string\">'root-modal'</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span>getInitialProps <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getInitialAppProps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">store</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">context</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> appInitialProps <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> App<span class=\"token punctuation\">.</span><span class=\"token function\">getInitialProps</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">const</span> cookieObject <span class=\"token operator\">=</span> <span class=\"token function\">cookieStringToObject</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>req<span class=\"token operator\">?.</span>headers<span class=\"token punctuation\">.</span>cookie<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> isLogged <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isLogged <span class=\"token operator\">&amp;&amp;</span> cookieObject<span class=\"token punctuation\">.</span>access_token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\taxios<span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>cookie <span class=\"token operator\">=</span> cookieObject<span class=\"token punctuation\">.</span>access_token<span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">meAPI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tstore<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>userActions<span class=\"token punctuation\">.</span><span class=\"token function\">setLoggedUser</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>appInitialProps <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">withRedux</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"issue2-로그인한-사용자의-예약-내역-가져오기\" style=\"position:relative;\"><a href=\"#issue2-%EB%A1%9C%EA%B7%B8%EC%9D%B8%ED%95%9C-%EC%82%AC%EC%9A%A9%EC%9E%90%EC%9D%98-%EC%98%88%EC%95%BD-%EB%82%B4%EC%97%AD-%EA%B0%80%EC%A0%B8%EC%98%A4%EA%B8%B0\" aria-label=\"issue2 로그인한 사용자의 예약 내역 가져오기 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Issue2. 로그인한 사용자의 예약 내역 가져오기</h2>\n<p>로그인된 사용자의 user id를 가져오고, 해당 user id의 예약 내역을 가져와서 redux store에 저장하고, 컴포넌트에서 store에 저장된 값을 사용해서 렌더링을 해주고 싶었다.</p>\n<p>처음에는 페이지에서 <code class=\"language-text\">getServerSideProps</code>를 사용하려고 했다. 그런데 <code class=\"language-text\">getServerSideProps</code> 함수 내에서 보낸 dispatch가 클라이언트 측 상태에 반영이 안 되는 문제가 있었다…</p>\n<br> \n<p>✅ pages/reservation/index.tsx</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> NextPage <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> ReservationMain <span class=\"token keyword\">from</span> <span class=\"token string\">'../../components/reservation/ReservationMain'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> wrapper <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../store'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getUserReservationAPI <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../lib/api/reservations'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> reservationActions <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../store/reservation'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> cookieStringToObject <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../lib/utils'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'../../lib/api'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> index<span class=\"token operator\">:</span> <span class=\"token function-variable function\">NextPage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>ReservationMain <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> getServerSideProps <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getServerSideProps</span><span class=\"token punctuation\">(</span>\n \t<span class=\"token punctuation\">(</span><span class=\"token parameter\">store</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n \t\t<span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>etc <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n \t\t\t<span class=\"token keyword\">const</span> userId <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span>\n \t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n \t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n \t\t\t\t\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserReservationAPI</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \t\t\t\t\tstore<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>reservationActions<span class=\"token punctuation\">.</span><span class=\"token function\">setUserReservations</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \t\t\t\t<span class=\"token punctuation\">}</span>\n \t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n \t\t\t\tconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \t\t\t<span class=\"token punctuation\">}</span>\n \t\t<span class=\"token punctuation\">}</span>\n <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> index<span class=\"token punctuation\">;</span></code></pre></div>\n<p>(HYDRATE Action에 Payload로 들어간 것까진 확인됨)</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1041px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 71.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACBUlEQVQ4y41Ty27TQBT1PyPBr3TFGoEACcSGfbsDCbViUSltQuRH/LbHsefh8eHcSapCVSUd5XjGvnfOPfeRaPXzGpttjCRJ0DRNQNu2AXJWSv2Hvu8D5DwMA9I0xWq1wnq9xna7RVReXiHJMpRliaauUVUVuq4LF4qiOHw/BhKIPY5j1PR98Nvv90GA2CI1TXi6lmUJjiMd5XKWpSTOiR3yPKOaeypLAqmQlGUVdgkYVWURXg6GMjhNDJJRtXzr+45KBqoAjAGcO8AYT0yEhtaGuwkliESqkDxAoozjeKxlQyKNea6o7IL2C9q+kfCWefT/5hSeWmtEOLHm2VKhZQmuGeANmvY1CV9h9h9o/USar9wV7QfSQCj1eg6ynLNMg3niD5gVqlqC8NXzNwt+w7u3WPzdUeF4htAaNkfzdI9BpaEZOzbF9DV0y1rXGiMbZcd3Qgc92edTflToSNjxtGYtexJuUOQ7TGyU4SyavoFRDt4n9LmlwuUcoWfKO55W7OISuujYVcs9EHK07LAnIUcAMee2PU1oradCIdywGRZqUMd+PvHHyOeW/7biJQrzEH2aHIc55ruCG0XZIW3dLVR9F8qS52cUuqBQCG+4W2w2CbJdC61mmIFtkOZ0N7D6veTDLPRpwmWZw5h4f8ka/uIFpj79gJu/wy8fic/EFyINszh7h7+EwTgKT7XksgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"1\" title=\"1\" src=\"/static/db22be285d82f3be3e6aab3cfb155422/ee9b6/1.png\" srcset=\"/static/db22be285d82f3be3e6aab3cfb155422/5a46d/1.png 300w,\n/static/db22be285d82f3be3e6aab3cfb155422/0a47e/1.png 600w,\n/static/db22be285d82f3be3e6aab3cfb155422/ee9b6/1.png 1041w\" sizes=\"(max-width: 1041px) 100vw, 1041px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<p>(하지만 State에 반영 안됨… 왤까…?)</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1041px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 86.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAA7DAAAOwwHHb6hkAAACOklEQVQ4y51Uy27bMBDU/x977r0fkUPhSy5Fz0US11FsS6LeFknJD1me7qwiw04TBwiBAUVqOdxd7mzwnKQwWQ6TZiirWpEVJYqyUmRFgfx1Pc1ZUeE5ylFUDeK0wJ/5C8IwRBQnCP7e/cTD4xzr9RpZlglSlGWJuq6RpimstfDewzkHL+C6qio01st+i0psTZIgjmPlCJqnRzVu2xa73Q7b7VbRdZ3uJ2JciJe8hPP0naYGy+VSL95sNnoJ9wMnJMMw4HQ6XWHyjF4aY5SIhwn+G0lTNE1zBomDIs8RRRHWq5WCrtNbzjzAbxJXdYXDocfxOAiOZyc4c83vtu0QMExiv99fgXsMm4SE0Xx2SvjR4JkAN8YgN9M7hkhveRHH2/QQHFsSvvdzMuj7fnwseSTm0TovIf5vN80feviW0AnRYrGQOjNo/f71/xcIj8deQ+66LRxfvfXoJQ2XYV/aa9ncJOx7LV7vrXjZ4DTwQfiifGG1vLKPpWY/zaH3VMceRb6VcOWhBijZSHo6lw4H8/wJ4UFyeJDczJDn36Vwf4in3+T//N2qoKpulg0Llg/iXCRePgl+Ce507dwozUm2HKoUJpIbrDWCBk1jxaMcuXQhajYM16JbI+qpBI0oyyA1saqJoNJms5meCegmhW0v9FiLzCaxj+IfYW2jj+OcxUu80VbHM7S7v78fQ14uRcNyw4ZkgkT6W7gyY9+TG8uKfZGNYOyX1koEEsnvB+kBJtemkUkktTiSJAb/AFUJHYN/4BfaAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"2\" title=\"2\" src=\"/static/f4b053c642b0cf23ae5a992e6fa5ecda/ee9b6/2.png\" srcset=\"/static/f4b053c642b0cf23ae5a992e6fa5ecda/5a46d/2.png 300w,\n/static/f4b053c642b0cf23ae5a992e6fa5ecda/0a47e/2.png 600w,\n/static/f4b053c642b0cf23ae5a992e6fa5ecda/ee9b6/2.png 1041w\" sizes=\"(max-width: 1041px) 100vw, 1041px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<p>createWrapper 에 {debug : true}로 설정하고 콘솔에 찍힌 결과를 보면.. initialStateFromGSPorGSSR 이라는 곳에 들어가 있는데 이걸 어디서 어떻게 활용할 수 있는지 잘 모르겠다…</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 510px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 98%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADpUlEQVQ4y5VUz4scRRidf1ASBUMgq0nA5KaI4FFhNyBeAh4MkeQmChKjFw/qRRQR48HLYnazO5ndmUn/7uqurv5d3V39fNUzG1fiITY8qqqn+pvvve993yyOYyydJU7cAE0zIo5TZJmEynNIpZCm3KscQRAiSQRikaAsSyRc7W9xFMHG0FpjMAazyPsey8NXsT7ZgQo+wDDUmJ6hB8yA/3rGcYQhxi0MA9m17wfM2lYiWR5DhU+Ywc8I/DVUplA6DlQkUTcdXvbp+x6zptFwH/vwDgT8pyVEoBBFyUTR9wXCYEOx5b2iKFAWJcZhQFVWlKhB33XIKYkNNvD9rOs7ZEGGeLEk/kIpFtCli66rSWXk/5qJkt1vVnOOpnmRsv0kjX7As/1X4B9dgnf4OoL5JQp9gRcebcmYFzQ8dzhHmQH73iCLV8jSOTWMWbkMSRrhmfMn9ROoqKEmlbptMb6MhlWl4R+WCOcawbJm0Baem0BEOao4Qbxew58fQ/ghilRNNonCEEJkPEtInq3eWncbDdvWRxp+B5k8oLe+pcC/stK/Q6YBDIvRJQk0PzJVhaGuJ781XOu6wWCLYvdcbbApYJb8Bu/JDUSn78M5fhvO0VVEJ28i2L+IWi7wf56JMjOFWLaQHqudGYS+mrogcx9DeD4zLfjPmpW0lNoJ49ht3/UYzSaz51Wum4oe9OEfZHCJTLBIaoRIDAvUM2BPH4I+BH0I+pCFZQNVfNewqXqNrQ/1hjIthFwcIDy6Rx/ehXTuo4y/RNv+xEt/kIi1zkPiE+IW8RFxh/iC+IXwzlHuMLMbGX1MD76HaHUX8eozeE/3EIbvwvNeY5ZXWYBdZnOPWX3NtvwcZfUp+nIPWryFTl6ATnZg+n2Q8SZgp++jUrd5+SGq9htOl6+Q5z8yyD7fzaltRloKUga0jINUsvqyR72iXQL2u3OH1Hc5bc4Cdrzk30Li7zKjPdTVh8iLdxjgDepynTeuEdcpvMU1Yocmv7I93yQuE49ImQEHjikpCqQCbDfDDOxMHLFaK2Y50Hdselazs+o/7xW7Z1VQETFR/2Mba8poQSoLF8HKZVZ2wjiEhzrn0GAXRLSPiFLUZYtM0gkyR1F2qIsaivRTdpAtyLZTWggnZj+nEHZaS8VO8ZFTtz5N0LguytNTaiahOSeLImcQthz3mlO9pbaZUtvxxYmteLC9GQYBezKgqQWWy1NeyieCdqyb8d+j62xkme3kPvut63r8DS2T5Y+G5ERCAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"3\" title=\"3\" src=\"/static/5b8e1b0f39b86356d31049ceb264415b/0abdd/3.png\" srcset=\"/static/5b8e1b0f39b86356d31049ceb264415b/5a46d/3.png 300w,\n/static/5b8e1b0f39b86356d31049ceb264415b/0abdd/3.png 510w\" sizes=\"(max-width: 510px) 100vw, 510px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n<br>\n<p>그래서 serverSideProps 대신에 <code class=\"language-text\">getInitialPageProps</code>를 사용해보려고 하니, user id를 받아오는 게 문제였다. page의 getInitialPageProps 가 _app의 getInitialProps보다 먼저 실행돼서 아직 로그인한 사용자 정보가 store에 들어가지도 않은 시점에서 접근해버린다. </p>\n<p>그래서.. 어쩔 수없이 여기에서도 로그인한 사용자 정보를 가져오는 api를 호출하는 방식으로 일단 해결은 했는데 ㅠ 이게 맞는 방법인지 모르겠다. </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">index<span class=\"token punctuation\">.</span>getInitialProps <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getInitialPageProps</span><span class=\"token punctuation\">(</span>\n\t<span class=\"token punctuation\">(</span><span class=\"token parameter\">store</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n\t\t<span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>etc <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token comment\">// const userId = store.getState().user.id;  불가</span>\n\t\t\t<span class=\"token keyword\">const</span> cookieObject <span class=\"token operator\">=</span> <span class=\"token function\">cookieStringToObject</span><span class=\"token punctuation\">(</span>req<span class=\"token operator\">?.</span>headers<span class=\"token punctuation\">.</span>cookie<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> isLogged <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isLogged <span class=\"token operator\">&amp;&amp;</span> cookieObject<span class=\"token punctuation\">.</span>access_token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\taxios<span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>cookie <span class=\"token operator\">=</span> cookieObject<span class=\"token punctuation\">.</span>access_token<span class=\"token punctuation\">;</span>\n\t\t\t\t\t<span class=\"token comment\">// 로그인한 사용자 정보 호출</span>\n                    <span class=\"token keyword\">const</span> userRes <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">meAPI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t<span class=\"token keyword\">const</span> userId <span class=\"token operator\">=</span> userRes<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span>\n\t\t\t\t\t\n                    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserReservationAPI</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\tstore<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>reservationActions<span class=\"token punctuation\">.</span><span class=\"token function\">setUserReservations</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>💛 피드백과 조언 부탁드립니다 💛</p>\n<hr>\n<p>참고자료</p>\n<p><a href=\"https://github.com/kirill-konshin/next-redux-wrapper\">https://github.com/kirill-konshin/next-redux-wrapper</a></p>\n<p><a href=\"https://helloinyong.tistory.com/315\">https://helloinyong.tistory.com/315</a></p>","tableOfContents":"<ul>\n<li><a href=\"/Next.js/next-redux-wrapper/#nextjs%EC%9D%98-pre-rendering\">Next.js의 Pre-rendering</a></li>\n<li><a href=\"/Next.js/next-redux-wrapper/#next%EC%97%90%EC%84%9C-redux%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%A0%A4%EB%A9%B4\">Next에서 Redux를 사용하려면?</a></li>\n<li><a href=\"/Next.js/next-redux-wrapper/#issue1-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%83%81%ED%83%9C-%EC%9C%A0%EC%A7%80%ED%95%98%EA%B8%B0\">Issue1. 로그인 상태 유지하기</a></li>\n<li><a href=\"/Next.js/next-redux-wrapper/#issue2-%EB%A1%9C%EA%B7%B8%EC%9D%B8%ED%95%9C-%EC%82%AC%EC%9A%A9%EC%9E%90%EC%9D%98-%EC%98%88%EC%95%BD-%EB%82%B4%EC%97%AD-%EA%B0%80%EC%A0%B8%EC%98%A4%EA%B8%B0\">Issue2. 로그인한 사용자의 예약 내역 가져오기</a></li>\n</ul>","frontmatter":{"title":"[Next.js] next-redux-wrapper 사용하기","date":"February 07, 2022"}}},"pageContext":{"slug":"/Next.js/next-redux-wrapper/","previous":{"fields":{"slug":"/JavaScript/2-브라우저렌더링/"},"frontmatter":{"title":"브라우저 렌더링"}},"next":null}}}